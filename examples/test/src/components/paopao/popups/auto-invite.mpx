<!-- 预约成功之后，主态进入自己的页面都会弹出这个弹窗 -->
<template>
  <base-popup
    wx:ref="autoInvite"
    title="{{content.dialog_title}}"
    bind:emitBaseEvent="emitEvent"
    refKey="{{refKey}}"
  >
    <view class="auto-invite-popup-content">
      <text class="auto-invite-popup-content-txt">{{formattedHTMLString.preTxt}}</text>
      <number-animation
        wx:if="{{showNumberAnimation}}"
        wx:ref="autoInviteNumber"
        class="auto-invite-popup-content-number" 
        wx:class="{{numberClass}}"
        value="{{formattedHTMLString.numTxt}}"
      >
      </number-animation>
      <view class="auto-invite-popup-content-txt">
        {{formattedHTMLString.afterTxt}}
        <view class="auto-invite-popup-content-badge" wx:if="{{showBadge}}">
          <view wx:for="{{badgeTexts}}" wx:key="index">{{item}}</view>
        </view>
      </view>
    </view>
    <view class="auto-invite-popup-tips-wrapper">
      <view
        wx:if="{{content.desc}}" 
        class="auto-invite-popup-tip"
      >{{content.desc}}</view>
      <view
        wx:if="{{content.sub_desc}}"
        class="auto-invite-popup-tip"
      >{{content.sub_desc}}</view>
    </view>
    <view
      wx:if="{{ __mpx_mode__ === 'web' }}"
      @click.stop="invite"
      class="auto-invite-popup-button"
    >{{content.button_desc}}</view>
    <button
      wx:else
      class="auto-invite-popup-button"
      open-type="share"
      id="autoInviteBtn"
      data-title="{{content.button_desc}}"
      data-desc="{{content.tip}}"
    >{{content.button_desc}}</button>
  </base-popup>
</template>

<script>
  import { createComponent } from '@mpxjs/core'
  import emitEvents from '../../../common/mixins/emitEvents'
  import { trackEvent } from '../../../common/js/Omega'

  createComponent({
    properties: {
      popupInfo: {
        type: Object,
        value: {}
      }
    },
    data: {
      badgeTexts: ['最', '高'],
      refKey: 'autoInvitePopup',
      showNumberAnimation: false
    },
    mixins: [emitEvents],
    computed: {
      content () {
        return this.popupInfo.context || {}
      },
      formattedHTMLString () {
        const separator = '  '
        const str = (this.content.tip || '').replace(/\{|\}/g, separator)
        const strMap = str.split(separator)
        console.log('strMap[1] ', strMap[1])
        return {
          preTxt: strMap[0],
          numTxt: strMap[1],
          afterTxt: strMap[2]
        }
      },
      numberClass () {
        const len = (this.formattedHTMLString.numTxt + '').length
        return len > 1 ? 'multiple-number' : 'single-number'
      },
      showBadge () {
        const dialogTitle = this.content.dialog_title || ''
        // 临时hack解决一下 AB弹窗的样式
        // A 弹窗不需要展示最高，title 是 全天可享叠加奖励
        return dialogTitle.indexOf('叠加奖励') === -1
      }
    },
    methods: {
      toggle () {
        const dialog = this.$refs.autoInvite
        dialog && dialog.toggle()
        this.showNumberAnimation = true
      },
      invite () {
        this.toggle()
        this.triggerEvent('inviteSignUp')
        trackEvent('wyc_mkt_ppyuyue_leader_share_pop_btn_ck', {
          btn_type: 2,
          btn_title: this.content.button_desc,
          btn_desc: this.content.tip
        })
      }
    }
  })
</script>

<style lang="stylus">
  @import "../../../common/stylus/mixin.styl"
  .auto-invite-popup-content
    display flex
    justify-content center
    align-items flex-end
    position absolute // 不用 padding-top 的原因是小程序样式表现不一致
    top vw(371)
    width 100%
    text-align center
    font-size vw(46)
    line-height vw(50)
    color #F45B3E
  .auto-invite-popup-content-badge
    position absolute
    top -55px
    right 0
    font-size 12px
    line-height 13px
    color #C6A368
    letter-spacing 1px
    padding 3px
    background-color #FFEEC9
    border-radius 4px
    font-weight normal
  .auto-invite-popup-content-txt
    position relative
    font-size vw(45)
    font-weight bold
  .auto-invite-popup-content-number
    font-family dinum
    color #EE5538
    font-size 103px
    line-height 120px
    font-weight normal
    &.single-number
      margin 0 vw(10)
  .auto-invite-popup-tips-wrapper
    position absolute
    bottom vw(198)
    width 100%
    text-align center
  .auto-invite-popup-tip
    font-size vw(34)
    font-weight bold
    color #FFEDDB
    line-height vw(48)
  .auto-invite-popup-button
    width vw(506)
    height vw(104)
    line-height vw(104)
    font-size 20px
    font-weight bold
    color #943025
    text-align center
    position absolute
    left vw(122)
    bottom vw(76)
    background-image url('https://dpubstatic.udache.com/static/dpubimg/34b80f06-d556-48b5-91aa-0ca20e3d03ef.png')
    background-size cover
    background-color transparent
    background-repeat no-repeat
    &:after
      border none
</style>

<script type="application/json">
  {
    "component": true,
    "usingComponents": {
      "base-popup": "./base",
      "number-animation": "../../number-animation/index"
    }
  }
</script>
