<template>
  <view class="receive-reward {{rewardType}} intersectionRootNode" v-exposure@web="exposure">
    <view class="receive-reward-content">
      <view class="receive-reward-left">
        <view class="receive-reward-icon"></view>
        <view class="receive-reward-title">{{title}}</view>
        <block wx:if="{{info.count_down_sec !== undefined}}">
          <view class="receive-reward-time-desc">距结束</view>
          <count-down
            remainingTime="{{info.count_down_sec}}"
            bind:finish="countDownFinish"
          />
        </block>
      </view>
      <horizontal-reward-container
        list="{{list}}"
        sizeType="{{sizeType}}"
        bind:clickItem="goRewardDetail"
      />
    </view>
  </view>
</template>

<script>
import { createComponent } from '@mpxjs/core'
import { universelPageJump } from '../../../common/js/pageJump'
import { trackAggregateEvent } from '../../../common/js/Omega'
import intersectionObserverMixin from '../../../common/mixins/intersectionObserver'
const REWARD_TYPE = {
  TRAFFIC: 'traffic',
  RUSH: 'rush'
}
const eventSwIdMap = {
  traffic: 'wyc_main_venue_jrjl_dck_sw',
  rush: 'wyc_main_chongdanjiang_sw'
}
const eventCkIdMap = {
  traffic: 'wyc_main_venue_jrjl_dck_ck',
  rush: 'wyc_main_chongdanjiang_ck'
}
const terraTimeRushOderType = 'terra_order_online_time' // 时长冲单(时长完单)

createComponent({
  mixins: [intersectionObserverMixin],
  options: {
    addGlobalClass: true,
    styleIsolation: 'shared'
  },
  properties: {
    info: {
      type: Object,
      value: {}
    },
    rewardType: {
      type: String,
      value: REWARD_TYPE.TRAFFIC // traffic(堵车卡) | rush(冲单奖)
    }
  },
  computed: {
    list () {
      const info = this.info || {}
      return info.list || []
    },
    sizeType () {
      if (this.rewardType === 'rush') {
        return 'size-middle'
      }
      return 'size-normal'
    },
    title () {
      // let _title = ''
      // switch (this.rewardType) {
      //   case REWARD_TYPE.TRAFFIC:
      //     _title = '堵车无忧卡'
      //     break
      //   case REWARD_TYPE.RUSH:
      //     _title = '冲单奖'
      //     break
      // }
      return this.info.title
    },
    intersectionOtherEventId () {
      // 小程序模块出现在视口的埋点
      return eventSwIdMap[this.rewardType]
    }
  },
  methods: {
    goRewardDetail (subItem = {}) {
      const item = subItem.detail || {}
      const params = {}
      if (this.rewardType === REWARD_TYPE.RUSH) {
        let actType = 1
        if (item.reward_type === terraTimeRushOderType) {
          actType = 2
        }
        params.act_type = actType
      }
      params.act_id = item.activity_id
      trackAggregateEvent(eventCkIdMap[this.rewardType], params)

      const url = item.jump_url || ''
      const ret = universelPageJump(url)
      // 走客服会话逻辑
      if (ret === true) {
        this.triggerEvent('customerService')
      }
    },
    exposure () {
      this.exposureH5()
    },
    exposureH5 () {
      this.list.map(item => {
        const params = {}
        if (this.rewardType === REWARD_TYPE.RUSH) {
          let actType = 1
          if (item.reward_type === terraTimeRushOderType) {
            actType = 2
          }
          params.act_type = actType
        }
        params.act_id = item.activity_id
        trackAggregateEvent(this.intersectionOtherEventId, params)
      })
    },
    countDownFinish () {
      this.triggerEvent('refresh')
    }
  }
})
</script>

<style lang="stylus">
@import "../../../common/stylus/mixin.styl"
.receive-reward
  margin-top vw(35)
  position relative
  width 100%
  height vw(233)
  border 2px solid #FDCB7D
  box-sizing border-box
  border-radius vw(20)
  background-color #FDEDD5
  &::after
    position absolute
    z-index 0
    top vw(8)
    right vw(8)
    bottom vw(8)
    left vw(8)
    display block
    content ' '
    border 1px solid #FDCB7D
    border-radius vw(15)
  &.rush
    .receive-reward-icon
      background-image url('https://dpubstatic.udache.com/static/dpubimg/4jkDc3trU7/square_rush_wallet.png')
  .count-down-component
    margin vw(3) auto 0
    display block
  .count-down-day2,
  .count-down-hour2,
  .count-down-minute2,
  .count-down-second2,
  .count-down-separator2
    font-size vw(18)
    line-height 1.167
    font-weight normal
    color #FFBB73
  .count-down-hour2
    margin-left vw(8)
.receive-reward-content
  position relative
  z-index 1
  top 0
  left 0
  width 100%
  height 100%
  padding vw(14) 0 vw(16) vw(174)
  box-sizing border-box
.receive-reward-left
  position absolute
  top -2px
  bottom 0
  left -2px
  width vw(170)
  height vw(233)
  padding-top vw(22)
  box-sizing border-box
  background url('https://dpubstatic.udache.com/static/dpubimg/LGqxnMfbbt/square_bg_left_title.png') center 0 no-repeat
  background-size contain
  text-align center
  font-size 0
.receive-reward-icon
  margin 0 auto
  width vw(106)
  height vw(106)
  background url('https://dpubstatic.udache.com/static/dpubimg/GK0ugRgiv0/square_traffic_yellow.png') center 0 no-repeat
  background-size contain
.receive-reward-title
  font-size vw(28)
  line-height 1
  font-weight bold
  color #FFEFC0
.receive-reward-time-desc
  margin-top vw(7)
  font-size vw(18)
  line-height 1.167
  color #FFBB73
</style>

<script type="application/json">
  {
    "component": true,
    "usingComponents": {
      "horizontal-reward-container": "./horizontal-reward-container",
      "count-down": "../../count-down/index"
    }
  }
</script>
