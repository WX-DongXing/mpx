<template>
  <view class="preparing-rewards-component intersectionRootNode" wx:if="{{list.length || supplyReward.title }}" v-exposure@web="exposure">
    <base-section title="{{title}}">
      <reward-order bindclicked="goRewardDetail(supplyReward)" info="{{supplyReward}}"></reward-order>
      <view wx:for="{{list}}" wx:key="index" class="preparing-rewards-group" wx:class="{{ {'is-last': index === (list.length - 1)} }}">
        <view class="preparing-rewards-subtitle">{{item.title}}</view>
        <reward-card bindclicked="goRewardDetail(subItem)" wx:for="{{item.items}}" wx:for-item="subItem" item="{{subItem}}" wx:key="index" />
      </view>
      <common-button bindclicked="goRewardCenter" text="去奖励中心查看" />
    </base-section>
  </view>
</template>

<script>
  import { createComponent } from '@mpxjs/core'
  import { DRIVER_REWARD_CENTER_URL } from '../../common/js/constants'
  import { universelPageJump } from '../../common/js/pageJump'
  import { trackAggregateEvent } from '../../common/js/Omega'
  import intersectionObserverMixin from '../../common/mixins/intersectionObserver'

  createComponent({
    mixins: [intersectionObserverMixin],
    data: {
      intersectionEventId: 'wyc_sdmarketing_jlyg_sw' // 小程序模块出现在视口的埋点
    },
    properties: {
      info: {
        type: Object,
        value: {}
      }
    },
    computed: {
      title () {
        return this.info.head_title || ''
      },
      list () {
        return this.info.list || []
      },
      supplyReward () {
        return this.info.supply_reward || {}
      }
    },
    methods: {
      goRewardCenter () {
        trackAggregateEvent('wyc_sdmarketing_jlygbutton_ck')
        const ret = universelPageJump(DRIVER_REWARD_CENTER_URL)
        // 走客服会话逻辑
        if (ret === true) {
          this.triggerEvent('customerService')
        }
      },
      goRewardDetail (subItem) {
        const url = subItem.jump_url || ''
        const ret = universelPageJump(url)
        // 走客服会话逻辑
        if (ret === true) {
          this.triggerEvent('customerService')
        }
      },
      exposure () {
        trackAggregateEvent('wyc_sdmarketing_jlyg_sw')
      }
    }
  })
</script>

<style lang="stylus">
  .preparing-rewards-component
    margin-top 36px
    border-radius 10px
    .preparing-rewards-subtitle
      margin-bottom 12px
      font-size 14px
      color #b75e41
      text-align center
    .preparing-rewards-group
      &.is-last
        margin-bottom 0
</style>

<script type="application/json">
  {
    "component": true,
    "usingComponents": {
      "reward-card": "../cards/reward",
      "base-section": "./base",
      "common-button": "../base/common-button",
      "reward-order": "../cards/reward-order"
    }
  }
</script>
